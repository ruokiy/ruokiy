<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[【原】基于Jenkins Freestyle Job构建CI/CD流水线]]></title>
    <url>%2F2018%2F10%2F07%2Fjenkins-freestyle-cicd-pipeline%2F</url>
    <content type="text"><![CDATA[可能有人会问：“现在流行的是Jenkins Pipeline 2.0(Jenkinsfile)，所有人都在谈论和使用, 为什么还在用Freestyle Job, 是不是太low了！”。的确，Jenkins Pipeline 2.0现在很流行，几乎就等同于Jenkins平台上构建CI/CD流水线的标准，如果你不使用Jenkins Pipeline 2.0，那么就等于不懂CI/CD。我承认Jenkins Pipeline 2.0带来了很多革命性的理念，比如Build As Code, 但是我想说的是Jenkins Pipeline 2.0不等于CI/CD Pipeline,而且它的革命也不是很彻底。不过本文不会过多地去议论方法或工具的好坏，只是在Jenkins上利用一种非Jenkins Pipeline 2.0的方式去构建CI/CD流水线，并说明这种流水线的优缺点，以期能够给读者一次思维上的刷新。 一个典型的CI/CD流水线 上图是个典型的CI/CD流水线，由5个阶段（Phase）组成：Build/UT，Code Static Check，QA，STAGE和PROD。每个阶段（Phase）由一到多个任务（Task）组成，每个阶段（Phase）都有一个主任务（Task），阶段（Phase）之间的提升（Promotion）是由主任务（Task）的提升（Promotion）完成。同一个阶段（Phase）之间的任务（Task）可以串行执行，也可以并行执行。 如果一个任务（Task）是通过提升（Promotion）的方式触发的，那么在当前流水线中这个任务（Task）可以被重复触发。这为流水线带来了两个好处： 流水线可以从失败的点重新启动，而无需重新启动一个新的流水线实例：当一个任务（Task）的执行由于某种临时原因失败了，比如网络不稳定，磁盘空间满了，断电等，可以通过重新提升（Promotion）再次触发。尤其是在前置阶段（Phase）和任务（Task）比较耗时，或者需要征用外部资源的时候，这一点更显得重要。 调试CI/CD流水线时，无需重复启动一个新的流水线实例：这一点其实是上优点的延伸。调试流水线时往往是从前往后一个阶段（Phase）一个阶段（Phase）的调试，正是由于流水线可以从失败的点重新启动，可以直接略过通过的阶段（Phase），从失败的阶段（Phase）开始调试。 手动提升（Manual Promote）策略需要有权限的批准者根据提前制定好的质量关卡来决定是否需要提升（Promote）到下一个阶段（Phase）。在这个流水线中，QA阶段（Phase）到STAGE阶段（Phase），STAGE阶段（Phase）到PROD阶段（Phase）都需要手动提升（Mannual Promote），它们并不是在每一个流水线实例中都需要被触发。在开发的早期，软件还不是很稳定的时候，每一次的代码提交都会触发一个流水线实例，流水线实例往往会根据自动提升（Auto Promote）策略最大限度地往后续阶段（Phase）流转，如果在某一阶段（Phase）失败了，则会及时通知到相关开发人员，从而实现了及时反馈当前代码提交对软件质量的影响。 只要没有被清理掉， 流水线实例可以在任何时间被重新启动，状态也会自动恢复。这为流水线带来了以下的好处： 有时候由于质量和时间的原因，不一定会将最新版本的流水线实例从STAGE阶段（Phase）提升到PROD阶段（Phase），而是需要将几天前的已经处于STAGE阶段（Phase）的流水线实例提升到PROD阶段（Phase）； 流水线在停止状态不会占用任何Jenkins Master 或者 Slave节点资源。 往往是在第一个阶段（Phase）的构建（Build）任务（Task）中生成状态文件，后续阶段（Phase）只是拷贝和恢复，也有可能会添加更多的状态。 下图是状态存储与恢复的过程。 在上游阶段（Phase）的任务（Task）也就是Jenkins作业（Job）中将需要持久的状态以key-value的方式存储到build-info.prop文件中，并通过Jenkins Job的存档功能（Archive）将build-info.prop存到当前作业（Job）上，下游被触发的Jenkin作业（job）将上游作业（Job）的build-info.prop拷贝到本地工作区，将它注入为环境变量。 在Jenkins上实现这个CI/CD流水线Jenkins和必要的插件 Jenkins从Jenkins官网（https://jenkins.io）上下载最新版本的Jenkins并安装。或者，至少保证你的Jenkins版本在2.0以上，1.x版本还是太旧了。 必要的插件 Parameterized Trigger Pluginhttps://wiki.jenkins.io/display/JENKINS/Parameterized+Trigger+Plugin 在Jenkins pipeline2.0之前，Job之前的调用与被调用关系是通过这个插件或者一系列同类的插件实现的。 Delivery Pipeline Pluginhttps://wiki.jenkins.io/display/JENKINS/Delivery+Pipeline+Plugin 将Job的上下游调用关系图形化显示为流水线。这个插件实现了CI/CD流水线的两个概念：阶段（Phase）和任务（Task）。一个任务（Task）就是一个Jenkins Freestyle Job（作业），一个阶段（Phase）可以包含多个任务（Task）。下图是从插件的网站上截取出来的最终CI/CD流水线的样式： Promte Builds Pluginhttps://wiki.jenkins.io/display/JENKINS/Promoted+Builds+Plugin 这个插件提供了一系列上下游作业（Job）之间的触发策略，主要分为自动触发，手动批准触发和自定义条件触发。除了三种主要的触发策略，还提供了一些更精细的控制策略，比如当前的提升（promotion）依赖于另一个提升（promotion）。可参考插件的wiki文档和内联的注释详细了解每一个触发策略，选中适合当前CI/CD流水线建设的要求。 Copy Artifact Pluginhttps://wiki.jenkins.io/display/JENKINS/Copy+Artifact+Plugin 这个插件实现了实现了上下游作业（Job）传递数据的功能。在构建CI/CD流水线时，会将流水线的状态数据以key-value值的方式记录在文本文件中，并存档在当前的作业（Job）中。下游的作业（Job）可以通过这个插件从触发它的上游作业（Job）拷贝这个状态数据文件，加载成环境变量，从而实现状态的恢复。 EnvInject Pluginhttps://wiki.jenkins.io/display/JENKINS/EnvInject+Plugin 利用这个插件可以将流水线的以key-value值的方式存储的状态文件加载为当前阶段（Phase）当前任务（Task）的环境变量。 注意，key的名字不要包含中划线，否则Jenkins 作业（Job）不识别。 以上五个插件是实现CI/CD流水线必需的插件，装这四个插件可能还会自动安装一些依赖的插件。 Description Setter Pluginhttp://wiki.jenkins-ci.org/display/JENKINS/Description+Setter+Plugin 这个插件比较简单了，主要是用来设置Job(Task)的描述，这样在CI/CD流水线中能显示更多的信息。 Flexible Publish Pluginhttps://wiki.jenkins.io/display/JENKINS/Flexible+Publish+Plugin 这个插件主要是用来实现作业（Job）中的步骤（step）的控制流，扩展了Jenkins 作业（Job）的步骤（steps）只能顺序执行的方式。 Email-ext Pluginhttps://wiki.jenkins.io/display/JENKINS/Email-ext+plugin 扩展的邮件插件，能够定制复杂的邮件内容。邮件通知是一个成熟的CI/CD流水线必要的特征。 Token Macro Pluginhttps://wiki.jenkins.io/display/JENKINS/Token+Macro+Plugin 在作业（Job）的描述或通知邮件的内容中可以通过引用Jenkins当前构建（build）的环境变量实现描述或邮件内容的模板化。Token Macro插件则负责在运行时解析这些变量引用。 Jenkins Job配置为了实现这个CI/CD流水线，下图是一个Jenkins Job所需的步骤，但并不是所有的Job都需要实现所有的步骤。比如Build/UT阶段（Phase）的Build任务（Task）是整个流水线的第一个Jenkins作业（Job），所以不需要步骤3去拷贝流水线状态文件，也不需要步骤4去加载状态文件，而最后一个Smoke Test任务（Task）也不要步骤2去提升（Promote）到下一个阶段（Phase）或者任务（Task）。 步骤的一些说明： 配置“Delivery Pipeline”节。“Stage Name”是阶段（Phase）名，“Task Name”是这个Jenkins Job在这个阶段（Phase）中的任务（Task）名字； Jenkins作业（Job）提升（Promotion）的配置。在“Criteria”下选择提升（Promotion）的策略，在“Actions”中选择待触发的下游Jenkins作业（Job）； 从上游作业（Job）拷贝流水线状态文件； 将状态文件加载为当前作业（Job）的环境变量。 结束语每一种方法有它的优点，必定也有它的缺点，没有一种方法是银弹，可以解决一切问题，打败天下无敌手。是否使用它，就要自己去权衡：是它的优点给你带来了更多，还是它的缺点是当前的最大障碍。这种方法的缺点大致如下： 仅管“Delivery Pipeline Plugin”可以图形化显示Jenkins Pipeline 2.0（Jenkinsfile）作业（Job）的上下游调用关系，但是“Promotes Builds Plugin”不支持Jenkins Pipeline 2.0（Jenkinsfile），所以太多的Freestyle Job要去创建，设置和维护，这些Job只能作为配置存储在Jenkins Master服务器上，而不能作为代码存储在Git中； 会多占用一些Slave节点的线程，因为作业（Job）的提升其实也是作业（Job）需要占用一个Slave线程。 期待“Promotes Builds Plugin”能够支持Jenkins Pipeline 2.0 （Jenkinfile），这样所有的任务（Task）也就是Jenkins作业（Job）全部可以作为代码存储在Git中，而且维护起来也很方便。]]></content>
      <tags>
        <tag>DevOps</tag>
        <tag>CI/CD</tag>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[【原】Hexo+Gitee(码云)搭建静态博客网站]]></title>
    <url>%2F2018%2F08%2F17%2Fsetup-blog-hexo-gitee%2F</url>
    <content type="text"><![CDATA[直接注册和使用当下比较流行的博客网站比如csdn, oschina, 博客园等等，觉得不是自己专属，而且还有很多广告。选择一款开源或免费的CMS(内容管理系统)，自己买云主机和域名搭建博客，费钱又费时。有时我们只是希望有一个功能不太复杂，自己专属的或者看起来自己专属的（至少没有一堆广告）博客网站来写写和分享自己的文章。不需要花费太多的时间和钱，除非你的博客和文章已经足够热门。基于以上的期望，本文将介绍如何使用Hexo搭建静态博客网站，并将其发布到GITEE(码云)免费提供的静态网页空间里。 Hexo是什么Hexo是一款免费的用来快速搭建静态博客网站的框架。支持插件机制，简单又不失强大。Hexo是基于Node.js开发的，提供了一组命令用来创建和管理博客应用，创建和管理博客文章，将博客应用和文章发布成静态博客网站。Hexo使用Markdown语言来写博客，方便、快捷，不需要什么额外的排版工具就能使你的文章布局看起来很美观。下图是Hexo博客网站的结构： Gitee是什么Gitee（码云 gitee.com）是国内的一款基于Git的代码托管和协作开发平台，和GitHub, GitLab属于同一类型的产品。同GitHub和GitLab相比，Gitee具有以下几点优势： 支持免费的私有Git代码仓库 在国内，不需要科学上网，访问速度快 Gitee平台也提供了免费的静态页面托管服务“码云Pages”，可以用来托管博客，项目官网等静态网页。“码云Pages Pro”是这个服务的高阶收费版，支持发布代码仓库中的某个目录，支持自定义域名。 要详细了解Gitee的概念和使用，可以参考Gitee的官方在线帮助文档：https://gitee.com/help 本文将会在Gitee上创建Git代码仓库管理Hexo博客应用的代码和静态博客网站，同时将静态博客网页托管到“码云Pages”。 从零开始搭建专属博客介绍完Hexo和Gitee后，明白了它们的概念和用途。下面我们就从零开始完整地搭建一个自己专属的博客。 安装必备的软件 安装Node.js Mac上安装 Linux上安装 Windows上安装 安装Git客户端 Mac上安装 Linux上安装 Windows上安装 安装Hexo运行以下命令安装Hexo（Hexo命令行）到Node.js的全局空间： 1npm install -g hexo-cli Hexo是用Node.js开发的，所以它以npm包格式发布。 创建一个新的博客应用 依次执行以下shell命令创建一个缺省的博客应用： 123hexo init hexo-test-blogcd hexo-test-blognpm install 博客应用的文件结构：.├── _config.yml├── package.json├── scaffolds│ ├── draft.md│ ├── page.md│ └── post.md├── source│ └── _posts│ └── _drafts└── themes│ └── landscape _config.yml博客站点配置文件。 package.json博客应用引用的第三方Node.js包。 scaffolds脚手架是用来快速创建博客页面的模板。有三类模板，“文章”，“草稿”和“页面”。脚手架不是最终博客页面显示的模板，显示是由当前主题的layout文件夹中的模板负责。 source博客文章的存放目录。分为“_posts”和“_drafts”两个子目录，分别存放正式文章和草稿文章。 themesHexo博客的主题。缺省安装的主题是“landscape”。 执行以下命令构建博客应用，生成静态博客网站 12npm intallhexo generate 执行以下命令启动一个本地http服务查看静态博客网站 1hexo server 在浏览器中输入http://localhost:4000打开博客网站。 设置一些“应用配置”(_config.yml) 这里将根目录下的配置文件”_config.yml“称为”应用配置“以便与后面的“主题配置”区分看来。”主题配置“是位于博客应用的主题根目录下的配置文件，名字也是”_config.yml“。 title: 若一拾得 subtitle: 若一不一，知之不知 description: keywords: DevOps, Infrastructure As Code(IAC), CI/CD, Operation, Monitor, Python author: 若一 language: zh-Hans timezone: Asia/Shanghai url: http://www.ruokiy.com root: / permalink: :year/:month/:day/:title/ =&gt; 文章页面的永久链接 permalink_defaults: 可以参考Hexo的官方文档了解更多的Hexo命令。 为博客应用安装新的主题Hexo自带的主题“landscape”看起来平平，不够简洁也不够富丽，所以大部分人安装和初始化完Hexo博客应用后，接下来的一步就是安装配置自己喜欢的主题。下面就以以简洁著称的“NexT”主题为例，介绍安装和配置主题的步骤。 “NexT”主题在GitHub上，地址为https://github.com/theme-next/hexo-theme-next。 注意：GitHub上还有很多“NexT”的fork版, 上面的地址是官方最新的版本。https://github.com/iissnan/hexo-theme-next是“NexT”的一个老版本。 安装步骤 克隆“NexT”主题到博客应用的themes目录 1git clone https://github.com/theme-next/hexo-theme-next themes/next 修改“应用配置”使用“NexT”主题 theme: next 对“NexT”主题的一些配置这个段落加上后面的对接第三发系统部分将介绍一些常用的配置。如果需要更多的设置，可详细浏览“应用配置”和“主题配置”中的每一个可更改的配置，并参考对应的文档，或者Google、Baidu来了解配置的作用，分析是否能满足你的要求。 去除页脚中的有关“NexT”的信息和链接 编辑“主题配置”，将“footer|powered|enable”，“footer|powerer|version”，“footer|theme|enable”以及“footer|theme|version”都设成“false”。 添加“about”和“tags”页Hexo缺省支持这两个类型的页面。(1) 执行下面的命令，在根目录下的source目录中分别创建“about”和“tags”文件夹 12hexo new page abouthexo new page tags (2) 编辑“根目录/source/tags/index.md”，在头部加上“type: tags” 123456---title: tagsdate: 2018-08-17 14:57:19type: tagscomments: false--- (3) 编辑“主题配置”，将“menu|about”和“menu|tags”打开 设置博客版面样式也就是博客网站的样式，比如一列或者两列。可以通过“主题配置”中的“scheme”来设置。 开启博客首页文章自动摘录，以及摘录字数限制编辑“主题配置”，将“auto_excerpt|enable”设成“true”，设置“auto_excerpt|length”为指定的摘录字数。 根据描述，你也可以用符号“&lt;!-- more --&gt;”来精确控制自动摘录的结束点。 对接第三发系统完善博客应用由于Hexo产生的是静态博客网站，没有自己的独立数据库，所以很多功能需要利用第三方服务或者插件来完成。 评论系统如果不能科学上网的话，基本上不太可能使用国外的评论系统比如Disqus，Hypercomments，LiveRe等，要么访问速度慢，要么被墙。而国内可用的第三方评论系统也不是很多，多说和网易云跟帖已经关闭，畅言需要提供你的网站ICP备案号，否则只有15天的试用期。经过比较，发现Valine是一个比较轻量级的评论系统，速度快，不需要网站备案（说不定以后需要，先用着再说！）。 如果非要尝试畅言的话，可以参考这个博客文章https://blog.csdn.net/qq_32518231/article/details/78080184 给你的博客应用设置Valine评论系统的步骤：(1) 在LeanCloudhttps://www.leancloud.cn上注册一个账号； 博客的评论将存储在LeadCloud中。 (2) 进入控制台，创建一个开发版的应用； (3) 点击进入这个应用，并进入设置|应用key页面获取APP ID和APP KEY； (4) 修改主题配置，将valine|enable设为true，valine|appid设为上一步获取的APP ID，valine|appkey设为上一步获取的APP KEY。 需要将你的静态博客发布到线上才会看到文章末尾的valine评论模块 文章统计 添加“文章字数”和“文章平均阅读时间”统计。 (1) 在博客应用的根目录执行以下命令安装“hexo-sysmbols-count-time”插件 1npm install hexo-symbols-count-time --save (2) 修改应用配置添加以下配置加载“hexo-symbols-count-time”插件 12345symbols_count_time:symbols: truetime: truetotal_symbols: truetotal_time: true (3) 修改主题配置中的以下配置 123456symbols_count_time:separated_meta: trueitem_text_post: trueitem_text_total: trueawl: 4wpm: 275 社交分享添加模块https://github.com/theme-next/theme-next-needmoreshare2获得博客文章社交分享的功能。 (1) 执行以下命令安装needmoreshare模块 12cd themes/nextgit clone https://github.com/theme-next/theme-next-needmoreshare2 source/lib/needsharebutton 注意，这里一定得是克隆到“source/lib/needsharebutton”目录，名字不能错。 (2) 修改“主题配置”“needmoreshare2”的子选项开启社交分享功能 博客搜索(1) 在博客应用的根目录安装插件https://github.com/theme-next/hexo-generator-searchdb 1npm install hexo-generator-searchdb --save (2) 在“应用配置”中添加以下配置开启博客搜索功能 12345symbols_count_time: symbols: true time: true total_symbols: true total_time: true 部署静态博客网站到码云(Gitee)静态页面空间 在码云上创建一个与你账号同名的Git代码仓库，比如”ruokiy”; 在创建时选择用README初始化仓库，这样创建出来的代码仓库缺省会带有master分支 安装插件hexo-deployer-git 1npm install hexo-deployer-git --save 在“应用配置”中添加一下配置 1234deploy: - type: git repo: https://gitee.com/ruokiy/ruokiy.git branch: master 注意，最终deploy过程是将产生的静态博客网站文件提交到新创建的Git代码仓库的master分支上，所以做deploy的机子上需要能够写访问Git代码仓库。这里是通过https协议访问Git代码仓库的，所以你需要在deploy的机子上，也就是装有Git客户端的机子上设置以下的Git配置：git config –global credential.helper store尝试手动克隆一次代码仓库，根据提示输入用户名和密码，这样你的用户名和密码就会被缓存到机子上了。之后的访问都不要用户名和密码了。 在博客应用的根目录执行以下命令完成静态博客文件的上传 12hexo cleanhexo deploy 如下图，在码云上点击刚创建的代码仓库页面，点击菜单“Service|Gitee Pages”，在左侧选择“master”分支，点击“create”按钮 不到一分钟，你的静态博客网站就生成了。可以拷贝生成的网址输入到浏览器打开你的博客了，同时你也可以把这个网址分享给你的朋友，或者放在你的个人简介中。 最后一公里 - 将博客应用的代码托管到码云这里会用到Git submodule的概念。]]></content>
      <tags>
        <tag>Hexo</tag>
        <tag>Gitee</tag>
      </tags>
  </entry>
</search>
